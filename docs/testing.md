# Testing & Accuracy Verification

## Smoke Accuracy Scenario

Use `python scripts/smoke_accuracy.py` to assert that the consolidator keeps **точно** набор уникальных файлов:

1. Скрипт поднимает временные исходники с пересекающимися структурами, дубликатами и конфликтом имён.
2. Запускает производственный пайплайн (`validate_relationships → count_total_files → process_files → prune_empty_dirs`), специально внедряя `*.DS_Store` в целевую папку, чтобы убедиться, что очистка умеет удалять артефакты Finder.
3. Эмулирует несколько последовательных конфликтов, проверяя, что датовый модификатор добавляется прямо к имени файла (`name.ext__YYMMDD`, при конфликте столетий → `__YYYYMMDD`, далее `-HH`, `-MM`, `-SS`, счётчик) и остаётся читаемым.
4. Создаёт несколько файлов с разными именами, но одинаковым содержимым — smoke убеждается, что в результате остаётся только одна копия (по хэшу), итоговое имя очищено от слова `copy` и выбрана самая длинная версия (при равной длине — лексикографически максимальная без учёта регистра).
5. Сравнивает множества SHA-256 всех файлов источников и результата (игнорируя системные файлы); при расхождении, наличии пустых папок или остаточных `*.DS_Store` завершает работу с кодом 1.

Выход `Smoke-тест пройден` означает, что критерий «полный набор уникальных файлов без пропусков и дубликатов» соблюдён хотя бы на базовом кейсе.

## Последние smoke-прогоны (15 ноября 2025)

| Архитектура | Python | Лог | Примечание |
| --- | --- | --- | --- |
| macOS arm64 | 3.10.19 (`.venv`) | `docs/smoke_runs/2025-11-15-arm64.txt` | PyInstaller `dist/macos-arm64/dir-consolidator`, SHA-256 `71ef5ad73f1b80c993ed960a26174d4b6c455a3d325011a008646e7d421b7b00`. |
| macOS x86_64 (Rosetta) | 3.10.11 (`.venv-x86`) | `docs/smoke_runs/2025-11-15-x86_64.txt` | PyInstaller `dist/macos-x86_64/dir-consolidator`, SHA-256 `bd55b89686e80fee6deb36e2ebe48f6c2fe283ebbc6274753ceca85d49a06407`. |
| Universal2 | n/a | — | Объединён `lipo` из двух сборок, SHA-256 `480e7429add233a706df321d6f1e15e5196616b6aaaa37938b131c79d2a19c59`. |

Эти артефакты используются в README и маркетинговых материалах; при выпуске новой версии обновляйте таблицу и прикладывайте свежие логи в `docs/smoke_runs/`.

## Ручной контроль

- Перед любой реальной консолидацией убедитесь, что выбранная целевая папка пуста. Приложение само предложит очистить непустую директорию — подтверждение гарантирует отсутствие «хвостов» от прошлых запусков.
- При необходимости можно вручную воспроизвести проверку точности: собрать SHA-256 всех файлов двух исходных папок и сравнить их с множеством хэшей результата — множества должны совпадать один в один.
- После завершения работы приложения Finder может снова создать `.DS_Store`; при проверке «нет пустых папок» игнорируйте эти файлы или удалите их командой `find . -name '.DS_Store' -delete`, чтобы избежать ложных срабатываний.
- Для проверки удобочитаемости суффиксов дат можно открыть итоговую папку и убедиться, что у конфликтующих файлов имена отсортированы по времени (`__241108`, `__241108-10`, а при конфликте столетий `__21241108` и т. д.); smoke-сценарий проверяет этот порядок автоматически.
- Чтобы убедиться в очистке имён, найдите в источниках файлы с `copy` в названии — в результате они должны появиться без этого слова, максимум с датовым суффиксом.
- Если какие-то файлы/каталоги недоступны, ищите их в `consolidator_errors.log`: там перечисляются все пути, которые не удалось обработать даже после 5 попыток.
- `consolidator_errors.log` создаётся при каждом запуске: если ошибок нет, он содержит только шапку, зато в случае проблем можно сразу приложить его к отчёту.
- После крупных запусков фиксируйте в таблице Field Runs, помогает ли текущий прогресс-бар оценить остаток работы (если нет — добавляем задачу на улучшение). Масштабные прогоны (>10 GB) и связанные с ними метрики сейчас приостановлены до появления новых лимитов: актуальные примеры см. в секции Field Runs ниже.

Пример (ошибок нет):

```text
timestamp	action	path	error
Ошибок не обнаружено
```

Пример (ошибка доступа):

```text
timestamp	action	path	error
2024-11-10T12:34:56+00:00	read	/Volumes/source/missed	FileNotFoundError(2, 'No such file or directory')
```

## Field Runs / Feedback

До возобновления больших лимитов фиксируем только результаты baseline-прогона (~3.8 MB); 10 GB запуск, генератор данных и расширенные метрики ETA/TUI остаются в резерве.

| Дата | Источник | Контекст | Вывод | Реакция |
| --- | --- | --- | --- | --- |
| 2024-11-08 | Eugene | Консолидация `../test/1` + `../test/2` → `../test/res` | Пустые папки не остаются, `.DS_Store` очищаются, добавление суффикса даты востребовано | Логику очистки артефактов зафиксировали, реализовали ступенчатое именование по дате |
| 2024-11-08 | Eugene | Повторный прогон после требований «одна копия на хэш» и очистки имён | Подтверждено: вторые копии с тем же SHA-256 не попадают в результат, «copy» исчезает из имён | Дедуп по хэшу и очистка названий реализованы, smoke-сценарий обновлён |
| 2024-11-08 | Smoke (internal) | Мульти-источник (3+ папок), ретраи доступа, Unicode имена | Подтверждено: интерактивный ввод поддерживает несколько источников, лог ошибок создаётся, имена вида `name.ext__YYMMDD` читаемы, прогресс-бар растёт пропорционально файлам | Расширенный smoke зафиксирован, готовимся собрать реальные оценки прогресса |

### Шаблон реального прогона

Перед новым запуском заполните блок ниже и добавьте его в эту секцию:

| Пункт | Значение |
| --- | --- |
| Источников / файлов |  |
| Ориентировочный объём уникальных данных |  |
| Впечатление от прогресс-бара (нужен ли ETA?) |  |
| Содержимое `consolidator_errors.log` |  |
| Контрольный хэш (указать, GNU или macOS команда) |  |

#### 2025-11-08 · Eugene · `build/field_run/src_a+src_b+src_c` → `build/field_run/result`

| Пункт | Значение |
| --- | --- |
| Источников / файлов | 3 источника / 16 исходных файлов (14 уникальных после дедупликации) |
| Ориентировочный объём уникальных данных | ~3.8 MB (14 файлов без учёта `consolidator_errors.log`) |
| Впечатление от прогресс-бара (нужен ли ETA?) | Бар ведёт себя стабильно: total растёт по мере обхода, лог Rich фиксирует каждое «Хэшируем/Скопировано». На 16 файлах видно кратковременные скачки процента, но отсутствие ETA всё равно оставляет вопрос «сколько ещё» — на более длинных прогонах захотелось бы оценку времени. |
| Содержимое `consolidator_errors.log` | Только заголовок и строка `Ошибок не обнаружено`. |
| Контрольный хэш (указать, GNU или macOS команда) | macOS: ``LC_ALL=C find build/field_run/result -type f -print0 \| sort -z \| xargs -0 shasum -a 256 \| shasum -a 256`` → `87f511c97b1621d293604ddd5f6556caed37253e67057d4f81c23c272c1c9136`. |

Контрольный хэш результирующей структуры:

- **GNU find**  
  ```bash
  LC_ALL=C find result -type f -printf '%P\0' | sort -z | xargs -0 shasum -a 256 | shasum -a 256
  ```
- **macOS/BSD find**  
  ```bash
  LC_ALL=C find result -type f -print0 | sort -z | xargs -0 shasum -a 256 | shasum -a 256
  ```

### UX/TUI acceptance checklist (будущий релиз)

1. **Верхняя панель (TUI)**  
   - Отображает: Total, Processed, Duplicates, Errors (с текстовым индикатором и ссылкой на `consolidator_errors.log`), скорость/ETA.  
   - Требование: пользователь считывает состояние (включая наличие ошибок) ≤ 2 секунд.
2. **Список событий**  
   - Однострочные записи вида `Processing/Duplicate/Error …`, цвет + текстовый маркер (`⚠️`, `!!!`).  
   - Для headless запуска цвета отключаются, но текстовый маркер сохраняется.
3. **Минимальный размер окна**  
   - Проверяем, что TUI корректно отображается на 80×24 (верхняя панель помещается, список прокручивается).
4. **Headless/TEXT-only режим**  
   - Smoke запускает TUI с `TERM=dumb` или отключёнными цветами; индикаторы ошибок читаемы по тексту.
5. **ETA accuracy**  
   - На контрольном наборе данных сравниваем отображаемый ETA с реальным временем на середине и ближе к завершению; погрешность не должна превышать ±20 %.  
   - Результат фиксируется в `docs/testing.md` при UX-тесте.
